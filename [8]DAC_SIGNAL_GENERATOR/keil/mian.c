#include "LED.h"
#include "Key.h"
#include "OLED.h"
#include "delay.h"
#include "ti_msp_dl_config.h"

/*==================================================================================*/
//DAC输出引脚设置为PA15
/*==================================================================================*/
//matlab输出正弦波采样点函数参考,可以让ai仿写并修改输出参数:
/*
    % DAC输出范围（12位DAC）
    DAC_range = 2^12; % 4096个离散级别
     
    % 生成正弦波形数组
    num_samples = 256;
    t = linspace(0, 2*pi, num_samples); % 时间从0到2*pi，等分成512份
    sin_wave = sin(t);
     
    % 将正弦波形归一化到DAC输出范围（0到4095）
    normalized_sin_wave = (sin_wave + 1) * (DAC_range - 1) / 2;
     
    % 将归一化的数组四舍五入为整数
    dac_output_values = round(normalized_sin_wave);
     
    % 绘制DAC输出波形
    figure;
    plot(dac_output_values);
    title('DAC输出正弦波形');
    xlabel('样本');
    ylabel('DAC输出值');
    grid on;
     
    % 将数组保存到文件中
    writematrix(dac_output_values, 'dac_output_values.txt');
    disp('DAC输出值已保存到文件：dac_output_values.txt');
 */
/*==================================================================================*/

#define DAC12_REF_VOLTAGE_mV    (3300)

static uint8_t key;
static uint8_t gCounter;
static uint8_t Mode = 0,temp;

//正弦波数据表
const uint16_t Sine_wave[]={2048,2098,2148,2199,2249,2299,2349,2399,2448,2498,2547,2596,2644,2692,2740,2787,2834,2880,2926,2971,3016,3060,3104,3147,3189,3230,3271,3311,3351,3389,3427,3464,3500,3535,3569,3602,3635,3666,3697,3726,3754,3782,3808,3833,3857,3880,3902,3923,3943,3961,3979,3995,4010,4024,4036,4048,4058,4067,4074,4081,4086,4090,4093,4095,4095,4094,4092,4088,4084,4078,4071,4062,4053,4042,4030,4017,4002,3987,3970,3952,3933,3913,3891,3869,3845,3821,3795,3768,3740,3711,3681,3651,3619,3586,3552,3517,3482,3445,3408,3370,3331,3291,3251,3210,3168,3125,3082,3038,2994,2949,2903,2857,2811,2764,2716,2668,2620,2571,2522,2473,2424,2374,2324,2274,2224,2174,2123,2073,2022,1972,1921,1871,1821,1771,1721,1671,1622,1573,1524,1475,1427,1379,1331,1284,1238,1192,1146,1101,1057,1013,970,927,885,844,804,764,725,687,650,613,578,543,509,476,444,414,384,355,327,300,274,250,226,204,182,162,143,125,108,93,78,65,53,42,33,24,17,11,7,3,1,0,0,2,5,9,14,21,28,37,47,59,71,85,100,116,134,152,172,193,215,238,262,287,313,341,369,398,429,460,493,526,560,595,631,668,706,744,784,824,865,906,948,991,1035,1079,1124,1169,1215,1261,1308,1355,1403,1451,1499,1548,1597,1647,1696,1746,1796,1846,1896,1947,1997,2047
};
//三角波数据表
const uint16_t triangle_wave[]={0,32,64,96,128,161,193,225,257,289,321,353,385,418,450,482,514,546,578,610,642,674,707,739,771,803,835,867,899,931,964,996,1028,1060,1092,1124,1156,1188,1220,1253,1285,1317,1349,1381,1413,1445,1477,1510,1542,1574,1606,1638,1670,1702,1734,1766,1799,1831,1863,1895,1927,1959,1991,2023,2056,2088,2120,2152,2184,2216,2248,2280,2312,2345,2377,2409,2441,2473,2505,2537,2569,2602,2634,2666,2698,2730,2762,2794,2826,2858,2891,2923,2955,2987,3019,3051,3083,3115,3148,3180,3212,3244,3276,3308,3340,3372,3404,3437,3469,3501,3533,3565,3597,3629,3661,3694,3726,3758,3790,3822,3854,3886,3918,3950,3983,4015,4047,4079,4079,4047,4015,3983,3950,3918,3886,3854,3822,3790,3758,3726,3694,3661,3629,3597,3565,3533,3501,3469,3437,3404,3372,3340,3308,3276,3244,3212,3180,3148,3115,3083,3051,3019,2987,2955,2923,2891,2858,2826,2794,2762,2730,2698,2666,2634,2602,2569,2537,2505,2473,2441,2409,2377,2345,2312,2280,2248,2216,2184,2152,2120,2088,2056,2023,1991,1959,1927,1895,1863,1831,1799,1766,1734,1702,1670,1638,1606,1574,1542,1510,1477,1445,1413,1381,1349,1317,1285,1253,1220,1188,1156,1124,1092,1060,1028,996,964,931,899,867,835,803,771,739,707,674,642,610,578,546,514,482,450,418,385,353,321,289,257,225,193,161,128,96,64,32,0
};
//方波数据表
const uint16_t square_wave[]={4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,4095,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4095
};
//上升沿锯齿波数据表
const uint16_t Sawtooth_Wave[]={2048,2064,2080,2096,2112,2128,2144,2160,2176,2192,2208,2224,2240,2256,2272,2288,2304,2321,2337,2353,2369,2385,2401,2417,2433,2449,2465,2481,2497,2513,2529,2545,2561,2577,2594,2610,2626,2642,2658,2674,2690,2706,2722,2738,2754,2770,2786,2802,2818,2834,2850,2867,2883,2899,2915,2931,2947,2963,2979,2995,3011,3027,3043,3059,3075,3091,3107,3123,3139,3156,3172,3188,3204,3220,3236,3252,3268,3284,3300,3316,3332,3348,3364,3380,3396,3412,3429,3445,3461,3477,3493,3509,3525,3541,3557,3573,3589,3605,3621,3637,3653,3669,3686,3702,3718,3734,3750,3766,3782,3798,3814,3830,3846,3862,3878,3894,3910,3926,3942,3958,3975,3991,4007,4023,4039,4055,4071,4087,8,24,40,56,72,88,104,120,136,153,169,185,201,217,233,249,265,281,297,313,329,345,361,377,393,409,426,442,458,474,490,506,522,538,554,570,586,602,618,634,650,666,682,699,715,731,747,763,779,795,811,827,843,859,875,891,907,923,939,956,972,988,1004,1020,1036,1052,1068,1084,1100,1116,1132,1148,1164,1180,1196,1212,1229,1245,1261,1277,1293,1309,1325,1341,1357,1373,1389,1405,1421,1437,1453,1469,1485,1502,1518,1534,1550,1566,1582,1598,1614,1630,1646,1662,1678,1694,1710,1726,1742,1758,1774,1791,1807,1823,1839,1855,1871,1887,1903,1919,1935,1951,1967,1983,1999,2015,2031,2048
};


//设置生成的波形
//正弦波
#define OUTPUT_SIGNAL0       Sine_wave
#define OUTPUT_SIGNAL_SIZE0  (sizeof(OUTPUT_SIGNAL0)/sizeof(uint16_t))

//三角波
#define OUTPUT_SIGNAL1       triangle_wave
#define OUTPUT_SIGNAL_SIZE1  (sizeof(OUTPUT_SIGNAL1)/sizeof(uint16_t))

//方波
#define OUTPUT_SIGNAL2       square_wave
#define OUTPUT_SIGNAL_SIZE2  (sizeof(OUTPUT_SIGNAL2)/sizeof(uint16_t))

//锯齿波
#define OUTPUT_SIGNAL3       Sawtooth_Wave
#define OUTPUT_SIGNAL_SIZE3  (sizeof(OUTPUT_SIGNAL3)/sizeof(uint16_t))


int main(void)
{
//    uint8_t DAC_value;

    SYSCFG_DL_init();
    LED_GPIO_init();
    KEY_GPIO_init();
    
    /*Set output voltage:
     * DAC value (12-bits) = DesiredOutputVoltage * 4095
     *                       ---------------------------
     *                           ReferenceVoltage
     */
//    //使能DAC中断
//    NVIC_EnableIRQ(DAC12_INT_IRQN);
    
    while(1)
    {
       
        //按键实现不同波形输出
        key=keyscan(0);
        if(key & KEY_Value)
        {
            Mode++;
            temp = Mode;
            gCounter = 0;
            Delay_ms(1);
        }
         switch(temp % 4) {
            case 0:
                DL_DAC12_output12(DAC0, OUTPUT_SIGNAL0[gCounter++]);
                if(gCounter >= OUTPUT_SIGNAL_SIZE0) {
                    gCounter = 0;
                }
                break;
                
            case 1:
                DL_DAC12_output12(DAC0, OUTPUT_SIGNAL1[gCounter++]);
                if(gCounter >= OUTPUT_SIGNAL_SIZE1) {
                    gCounter = 0;
                }
                break;
                
            case 2:
                DL_DAC12_output12(DAC0, OUTPUT_SIGNAL2[gCounter++]);
                if(gCounter >= OUTPUT_SIGNAL_SIZE2) {
                    gCounter = 0;
                }
                break;
                
            case 3:
                DL_DAC12_output12(DAC0, OUTPUT_SIGNAL3[gCounter++]);
                if(gCounter >= OUTPUT_SIGNAL_SIZE3) {
                    gCounter = 0;
                }
                break;
        }
    }
}

//void DAC12_IRQHandler(void)
//{
//    switch(DL_DAC12_getPendingInterrupt(DAC0))
//    {
//        case DL_DAC12_IIDX_FIFO_1_2_EMPTY:

//            break;
//        default:
//            break;
//    }
//}
